<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chess Coach</title>

    <!-- Board CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chessground@8.3.3/assets/chessground.base.css">

    <!-- Piece CSS - dynamically loaded by themes.js -->

    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="context-navigation.css">
    <link rel="stylesheet" href="enhanced-features.css">
    <link rel="icon" href="https://upload.wikimedia.org/wikipedia/commons/4/45/Chess_plt45.svg" type="image/svg+xml">
    <!-- PeerJS for WebRTC -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
</head>

<body>

    <!-- Persistent Header with Context-Aware Navigation -->
    <header class="app-header">
        <div class="header-left">
            <div class="app-logo">
                <span class="logo-icon">‚ôî</span>
                <span class="logo-text">AI Chess Coach</span>
            </div>
        </div>

        <div class="header-center">
            <nav class="primary-nav">
                <button class="nav-btn active" data-context="game-active" id="navPlayBtn" title="Play Chess">
                    <span class="nav-icon">üéÆ</span>
                    <span class="nav-label">New Game</span>
                </button>
                <button class="nav-btn" data-context="analysis" id="navAnalysisBtn" title="Analyze Positions">
                    <span class="nav-icon">üîç</span>
                    <span class="nav-label">Analysis</span>
                </button>
                <button class="nav-btn" data-context="learning" id="navLearnBtn" title="Learning & Training">
                    <span class="nav-icon">üìö</span>
                    <span class="nav-label">Learn</span>
                </button>
            </nav>
        </div>

        <div class="header-right">
            <div class="engine-status-group">
                <span class="engine-label desktop-only">Engine:</span>
                <button id="engineToggleBtn" class="engine-toggle" title="Switch between Local and Cloud engine">
                    <span class="engine-indicator active" id="engineIndicator">‚óè</span>
                    <span class="engine-text" id="engineText">Local</span>
                </button>
            </div>
            <button id="navSettingsBtn" class="settings-btn" data-context="settings" title="Settings">
                <span class="settings-icon">‚öôÔ∏è</span>
            </button>
            <button id="commandPaletteBtn" class="command-palette-btn desktop-only" title="Command Palette (‚åòK)">
                <span class="palette-icon">‚åò</span>
            </button>
            <button id="headerMenuBtn" class="header-menu-btn mobile-only">
                <span class="menu-icon">‚ò∞</span>
            </button>
        </div>
    </header>

    <!-- Main Layout Container -->
    <div class="layout-container">
        <!-- Left Panel (Optional, Collapsible) -->
        <aside class="left-panel" id="leftPanel">
            <div class="panel-header">
                <h3>Tools</h3>
                <button class="panel-collapse-btn" id="leftPanelCollapseBtn" title="Collapse panel">
                    <span class="collapse-icon">‚Äπ</span>
                </button>
            </div>
            <div class="panel-content">
                <!-- Learning Dashboard -->
                <div class="tool-section">
                    <h4>üìä Learning</h4>
                    <button id="leftLearningDashboardBtn" class="tool-btn">
                        Learning Dashboard
                    </button>
                </div>

                <!-- Quick Settings -->
                <div class="tool-section">
                    <h4>‚öôÔ∏è Quick Settings</h4>
                    <div class="quick-settings">
                        <label class="quick-setting-item">
                            <input type="checkbox" id="leftShowHints" checked>
                            <span>Show Hints</span>
                        </label>
                        <label class="quick-setting-item">
                            <input type="checkbox" id="leftAnalysisMode">
                            <span>Analysis Mode</span>
                        </label>
                        <label class="quick-setting-item">
                            <input type="checkbox" id="leftClockEnabled">
                            <span>Enable Clock</span>
                        </label>
                    </div>
                </div>

                <!-- Game History -->
                <div class="tool-section">
                    <h4>üìÇ Game Management</h4>
                    <div class="game-management-btns">
                        <button id="leftSaveGameBtn" class="tool-btn-sm">
                            <span>üíæ</span> Save
                        </button>
                        <button id="leftLoadGameBtn" class="tool-btn-sm">
                            <span>üìÇ</span> Load
                        </button>
                        <button id="leftExportPgnBtn" class="tool-btn-sm">
                            <span>üì§</span> Export
                        </button>
                        <button id="leftImportPgnBtn" class="tool-btn-sm">
                            <span>üì•</span> Import
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- Left Panel Collapse Toggle (when collapsed) -->
        <button class="panel-expand-btn left-expand" id="leftPanelExpandBtn" style="display: none;" title="Expand panel">
            <span class="expand-icon">‚Ä∫</span>
        </button>

        <!-- Center Panel (Board Area) -->
        <main class="center-panel">
            <div class="board-wrapper">
            <!-- Captured Pieces Display (Black's captures - above board) -->
            <div class="captured-pieces-container black-captures">
                <div class="captured-pieces-header">
                    <span class="player-label">Black</span>
                    <span class="material-value" id="black-material-value">0</span>
                </div>
                <div class="captured-pieces-list" id="black-captured-pieces">
                    <span class="no-captures">‚Äî</span>
                </div>
            </div>

            <div id="board" class="board is2d"></div>

            <!-- Captured Pieces Display (White's captures - below board) -->
            <div class="captured-pieces-container white-captures">
                <div class="captured-pieces-header">
                    <span class="player-label">White</span>
                    <span class="material-value" id="white-material-value">0</span>
                </div>
                <div class="captured-pieces-list" id="white-captured-pieces">
                    <span class="no-captures">‚Äî</span>
                </div>
            </div>

            <!-- Material Advantage Display -->
            <div class="material-advantage-display">
                <span id="material-advantage" class="material-advantage equal">Equal material</span>
            </div>
        </div>
        </main>

        <!-- Right Panel (Collapsible Sidebar) -->
        <aside class="right-panel" id="rightPanel">
            <div class="panel-header">
                <h3>Analysis</h3>
                <button class="panel-collapse-btn" id="rightPanelCollapseBtn" title="Collapse panel">
                    <span class="collapse-icon">‚Ä∫</span>
                </button>
            </div>

            <div class="sidebar">
            <!-- Fixed Top Section (Clocks & Essential Info) -->
            <div class="sidebar-top">
                <div class="chess-clock-panel" id="chessClockPanel">
                    <div class="clock-display">
                        <div class="clock-player" id="whiteClockPlayer">
                            <div class="clock-player-label">White</div>
                            <div class="clock-time" id="whiteClock">10:00</div>
                        </div>
                        <div class="clock-player" id="blackClockPlayer">
                            <div class="clock-player-label">Black</div>
                            <div class="clock-time" id="blackClock">10:00</div>
                        </div>
                    </div>
                </div>

                <div class="essential-info">
                    <div id="status">White to move</div>
                    <div id="difficultyBadge" class="difficulty-badge" style="display: none;">
                        <span class="difficulty-icon">üéØ</span>
                        <span id="difficultyValue">Medium</span>
                    </div>
                    <div id="ratingBadge" class="rating-badge" style="display: none;">
                        <span class="rating-icon">üìä</span>
                        <span id="ratingValue">~800</span>
                    </div>
                </div>

                <div id="evaluation-bar">
                    <div id="eval-fill"></div>
                </div>
            </div>

            <!-- Context-Aware Content Area -->
            <div class="context-content">
                <!-- CONTEXT: GAME ACTIVE (During gameplay) -->
                <div class="context-panel active" id="context-game-active">
                    <!-- Action Buttons - Moved up for accessibility -->
                    <div class="button-group compact">
                        <button id="resetBtn" class="primary-btn" title="Start a fresh new game">New Game</button>
                        <button id="undoBtn" title="Undo the last move">Undo</button>
                        <button id="flipBtn" title="Flip the board to play from the other side">Flip</button>
                    </div>

                    <button id="resignBtn" class="resign-btn" title="Resign and end the current game">
                        üè≥Ô∏è Resign
                    </button>

                    <div id="feedback" class="feedback-box">
                        Make a move to get coaching...
                    </div>

                    <button id="continueBtn" class="continue-btn" style="display: none;">
                        Ignore & Continue Game
                    </button>

                    <button id="analyzeGameBtn" class="analyze-game-btn" style="display: none;">
                        üìä Analyze Complete Game
                    </button>

                    <div class="move-history-panel">
                        <div class="move-history-header">
                            <h3>Move History</h3>
                            <div class="game-controls">
                                <button id="saveGameBtn" class="icon-btn"
                                    title="Save current game to browser storage">üíæ</button>
                                <button id="loadGameBtn" class="icon-btn"
                                    title="Load a previously saved game">üìÇ</button>
                                <button id="exportPgnBtn" class="icon-btn" title="Save game as a PGN file">üì§</button>
                                <button id="importPgnBtn" class="icon-btn"
                                    title="Import game from a PGN file">üì•</button>
                            </div>
                        </div>
                        <!-- Timeline-style move history -->
                        <div id="timelineMoveHistory" class="timeline-move-container">
                            <!-- Populated by visual-analysis.js -->
                        </div>
                        <!-- Classic move list (fallback) -->
                        <div id="move-list" class="move-list">
                            <div class="move-list-empty">No moves yet</div>
                        </div>
                    </div>

                    <button id="learningDashboardBtn" class="learning-btn">
                        üìä Learning Dashboard
                    </button>
                </div>

                <!-- CONTEXT: GAME ENDED (After game finishes) -->
                <div class="context-panel" id="context-game-ended">
                    <!-- Game Summary -->
                    <div class="game-summary-section">
                        <div class="summary-header">
                            <h3>üéØ Game Over</h3>
                            <div id="gameResult" class="game-result">-</div>
                        </div>

                        <!-- Accuracy Summary -->
                        <div id="gameEndedAccuracy" class="accuracy-summary">
                            <div class="accuracy-main">
                                <div class="accuracy-label">Your Accuracy</div>
                                <div class="accuracy-value" id="finalAccuracyValue">--%</div>
                            </div>
                            <div class="accuracy-breakdown">
                                <div class="accuracy-stat">
                                    <span class="stat-icon best">‚≠ê</span>
                                    <span id="finalBestMoves">0</span>
                                </div>
                                <div class="accuracy-stat">
                                    <span class="stat-icon good">!</span>
                                    <span id="finalGoodMoves">0</span>
                                </div>
                                <div class="accuracy-stat">
                                    <span class="stat-icon inaccuracy">!?</span>
                                    <span id="finalInaccuracies">0</span>
                                </div>
                                <div class="accuracy-stat">
                                    <span class="stat-icon mistake">?</span>
                                    <span id="finalMistakes">0</span>
                                </div>
                                <div class="accuracy-stat">
                                    <span class="stat-icon blunder">??</span>
                                    <span id="finalBlunders">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Critical Moments Summary -->
                        <div id="criticalMomentsEndedPanel" class="critical-moments-summary">
                            <h4>üîç Critical Moments</h4>
                            <div id="criticalMomentsEndedList" class="moments-list">
                                <!-- Will be populated by JS -->
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="post-game-actions">
                            <button id="reviewGameBtn" class="primary-btn">
                                üìä Review Full Game
                            </button>
                            <button id="newGameFromEndBtn" class="secondary-btn">
                                üéÆ New Game
                            </button>
                            <button id="saveCompletedGameBtn" class="secondary-btn">
                                üíæ Save Game
                            </button>
                        </div>
                    </div>
                </div>

                <!-- CONTEXT: ANALYSIS (Analysis mode) -->
                <div class="context-panel" id="context-analysis">
                    <!-- Mate Detection Alert -->
                    <div id="mateAlert" class="mate-alert" style="display: none;">
                        <div class="mate-icon">üéØ</div>
                        <div class="mate-info">
                            <div class="mate-title">Mate in <span id="mateInMoves">0</span>!</div>
                            <div class="mate-side" id="mateSide">White is winning</div>
                        </div>
                    </div>

                    <!-- Win Probability Display -->
                    <div id="winProbability" class="win-probability-panel" style="display: none;">
                        <div class="win-prob-header">Win Probability</div>
                        <div class="win-prob-bars">
                            <div class="win-prob-label white">
                                <span>White</span>
                                <span id="whiteWinPercent">50%</span>
                            </div>
                            <div class="win-prob-bar-container">
                                <div class="win-prob-bar white" id="whiteWinBar" style="width: 50%"></div>
                                <div class="win-prob-bar black" id="blackWinBar" style="width: 50%"></div>
                            </div>
                            <div class="win-prob-label black">
                                <span>Black</span>
                                <span id="blackWinPercent">50%</span>
                            </div>
                        </div>
                    </div>

                    <!-- Streaming Analysis Panel -->
                    <div id="streamingAnalysis" class="streaming-analysis-panel" style="display: none;">
                        <div class="streaming-header">
                            <span>üîÑ Live Analysis</span>
                            <span class="cloud-badge">Cloud</span>
                        </div>
                        <div class="depth-progress">
                            <div class="depth-label">Depth: <span id="currentDepth">0</span>/<span id="maxDepth">18</span></div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="depthProgress" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="streaming-eval">
                            <div class="eval-label">Evaluation:</div>
                            <div class="eval-value" id="streamingEval">+0.00</div>
                        </div>
                        <div class="streaming-continuation">
                            <div class="continuation-label">Best line:</div>
                            <div class="continuation-moves" id="streamingContinuation">-</div>
                        </div>
                    </div>

                    <!-- Visual Evaluation Card -->
                    <div id="visualEvaluationCard" class="visual-evaluation-card">
                        <!-- Populated by visual-analysis.js -->
                    </div>

                    <!-- Position Insights Panel -->
                    <div id="positionInsightsPanel" class="position-insights-panel">
                        <!-- Populated by visual-analysis.js -->
                    </div>

                    <!-- Opening Information -->
                    <div class="opening-panel">
                        <div class="opening-header">
                            <div id="opening-name" class="opening-name">Starting Position</div>
                            <div class="opening-meta">
                                <span id="opening-eco" class="opening-eco"></span>
                                <span id="opening-category" class="opening-category"></span>
                            </div>
                        </div>
                        <div id="opening-variations" class="opening-variations"></div>
                        <div id="opening-live-stats" class="opening-live-stats" style="display: none;"></div>
                    </div>

                    <!-- Analysis Tools -->
                    <div class="analysis-panel">
                        <h3>Analysis Tools</h3>
                        <div class="analysis-controls">
                            <button id="hintBtn" class="analysis-btn">üí° Get Hint</button>
                            <button id="analyzeBtn" class="analysis-btn">üîç Analyze</button>
                        </div>

                        <div id="bestMovesPanel" class="best-moves-panel" style="display: none;">
                            <div class="best-moves-header">Top Moves:</div>
                            <div id="bestMovesList" class="best-moves-list"></div>
                        </div>
                    </div>

                    <!-- Critical Moments & Puzzles -->
                    <div id="criticalMomentsPanel" class="critical-moments-panel" style="display: none;">
                        <h3>Critical Moments</h3>
                        <div id="criticalMomentsList" class="critical-moments-list"></div>
                    </div>

                    <div id="puzzlesPanel" class="puzzles-panel" style="display: none;">
                        <h3>Generated Puzzles</h3>
                        <div id="puzzlesList" class="puzzles-list"></div>
                    </div>

                    <!-- Match Analysis Step-by-Step -->
                    <div id="matchAnalysisPanel" class="match-analysis-panel" style="display: none;">
                        <div class="match-analysis-header">
                            <h3>üìã Match Analysis</h3>
                            <button id="closeMatchAnalysisBtn" class="close-analysis-btn">‚úï</button>
                        </div>

                        <!-- Analysis Progress -->
                        <div id="analysisProgress" class="analysis-progress" style="display: none;">
                            <div class="progress-info">
                                Analyzing match... <span id="analysisProgressText">0%</span>
                            </div>
                            <div class="progress-bar-container">
                                <div class="progress-bar" id="matchAnalysisProgressBar" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Accuracy Summary -->
                        <div id="accuracySummary" class="accuracy-summary">
                            <div class="accuracy-main">
                                <div class="accuracy-label">Accuracy</div>
                                <div class="accuracy-value" id="accuracyValue">--%</div>
                            </div>
                            <div class="accuracy-breakdown">
                                <div class="accuracy-stat">
                                    <span class="stat-icon best">‚≠ê</span>
                                    <span id="bestMovesCount">0</span>
                                </div>
                                <div class="accuracy-stat">
                                    <span class="stat-icon good">!</span>
                                    <span id="goodMovesCount">0</span>
                                </div>
                                <div class="accuracy-stat">
                                    <span class="stat-icon inaccuracy">!?</span>
                                    <span id="inaccuraciesCount">0</span>
                                </div>
                                <div class="accuracy-stat">
                                    <span class="stat-icon mistake">?</span>
                                    <span id="mistakesCount">0</span>
                                </div>
                                <div class="accuracy-stat">
                                    <span class="stat-icon blunder">??</span>
                                    <span id="blundersCount">0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Current Move Analysis -->
                        <div id="currentMoveAnalysis" class="current-move-analysis">
                            <div class="move-info-header">
                                <span id="moveProgressText">Move 1 of 40</span>
                            </div>

                            <div class="move-comparison">
                                <div class="move-played">
                                    <div class="move-label">Move Played</div>
                                    <div class="move-display">
                                        <span class="move-notation" id="playedMove">-</span>
                                        <span class="move-annotation" id="playedAnnotation"></span>
                                    </div>
                                    <div class="move-quality" id="playedQuality">-</div>
                                </div>

                                <div class="move-divider">‚Üí</div>

                                <div class="move-best" id="bestMoveSection">
                                    <div class="move-label">Best Move</div>
                                    <div class="move-display">
                                        <span class="move-notation" id="bestMove">-</span>
                                    </div>
                                    <div class="eval-loss" id="evalLoss">-</div>
                                </div>
                            </div>

                            <div class="evaluation-change">
                                <div class="eval-item">
                                    <span class="eval-label">Before:</span>
                                    <span class="eval-value" id="evalBefore">+0.0</span>
                                </div>
                                <div class="eval-item">
                                    <span class="eval-label">After:</span>
                                    <span class="eval-value" id="evalAfter">+0.0</span>
                                </div>
                            </div>
                        </div>

                        <!-- Navigation Controls -->
                        <div class="analysis-navigation">
                            <button id="firstMoveBtn" class="nav-btn" title="First move">‚èÆ</button>
                            <button id="prevMoveBtn" class="nav-btn" title="Previous move">‚óÄ</button>
                            <button id="nextMoveBtn" class="nav-btn" title="Next move">‚ñ∂</button>
                            <button id="lastMoveBtn" class="nav-btn" title="Last move">‚è≠</button>
                        </div>
                    </div>

                    <!-- Load Game for Analysis Button -->
                    <div class="load-match-analysis">
                        <button id="loadMatchAnalysisBtn" class="primary-btn">
                            üìä Analyze Saved Match
                        </button>
                    </div>
                </div>

                <!-- CONTEXT: LEARNING (Learning Dashboard) -->
                <div class="context-panel" id="context-learning">
                    <div class="learning-context-header">
                        <h3>üìö Learning & Training</h3>
                        <p class="context-description">Improve your chess with lessons, puzzles, and drills</p>
                    </div>

                    <!-- Learning Dashboard Button -->
                    <button id="openLearningBtn" class="primary-btn full-width">
                        üìä Open Learning Dashboard
                    </button>

                    <!-- Quick Learning Stats -->
                    <div class="learning-quick-stats">
                        <div class="stat-card">
                            <div class="stat-value" id="totalGamesPlayed">0</div>
                            <div class="stat-label">Games Played</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="averageAccuracy">--%</div>
                            <div class="stat-label">Avg Accuracy</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="puzzlesSolved">0</div>
                            <div class="stat-label">Puzzles Solved</div>
                        </div>
                    </div>

                    <!-- Daily Goals Widget -->
                    <div class="daily-goals-widget" id="dailyGoalsWidget">
                        <!-- Populated by daily-goals.js -->
                    </div>

                    <!-- Progress Tracker (Radar Chart) -->
                    <div class="progress-tracker-section">
                        <h4>üìä Your Skills</h4>
                        <div id="skillsRadarChart" class="skills-radar-container">
                            <!-- Populated by progress-tracker.js -->
                        </div>
                    </div>

                    <!-- Skill Progress Cards -->
                    <div class="skill-progress-cards" id="skillProgressCards">
                        <!-- Populated by progress-tracker.js -->
                    </div>

                    <!-- Quick Access to Training -->
                    <div class="learning-quick-access">
                        <h4>Quick Training</h4>
                        <button class="training-btn" id="openingsTrainerBtn">
                            ‚ôî Opening Trainer
                        </button>
                        <button class="training-btn" id="endgamesTrainerBtn">
                            ‚ôö Endgame Trainer
                        </button>
                        <button class="training-btn" id="tacticsTrainerBtn">
                            ‚ö° Tactics Puzzles
                        </button>
                    </div>

                    <!-- Achievement Showcase -->
                    <div id="achievementShowcase" class="achievement-showcase">
                        <!-- Populated by achievement-visuals.js -->
                    </div>
                </div>

                <!-- CONTEXT: SETTINGS -->
                <div class="context-panel" id="context-settings">
                    <div class="settings-section">
                        <h4>‚ö° Analysis Engine</h4>
                        <div class="engine-selector-panel">
                            <label class="engine-option">
                                <input type="radio" name="engine" value="local" id="engineLocal" checked>
                                <div class="engine-info">
                                    <div class="engine-name">üñ•Ô∏è Local Stockfish</div>
                                    <div class="engine-description">Private, works offline, uses your CPU</div>
                                </div>
                            </label>
                            <label class="engine-option">
                                <input type="radio" name="engine" value="cloud" id="engineCloud">
                                <div class="engine-info">
                                    <div class="engine-name">‚òÅÔ∏è Cloud API (80 MNPS)</div>
                                    <div class="engine-description">Instant analysis, zero CPU usage, requires internet</div>
                                </div>
                            </label>
                        </div>

                        <!-- Cloud-specific settings -->
                        <div id="cloudSettings" class="cloud-settings" style="display: none;">
                            <div class="control-group">
                                <label for="cloudDepth">
                                    Cloud Depth: <span id="cloudDepthValue">12</span>
                                </label>
                                <input type="range" id="cloudDepth" min="8" max="18" value="12" step="1">
                            </div>
                            <div class="control-group">
                                <label for="cloudVariants">
                                    Variants: <span id="cloudVariantsValue">3</span>
                                </label>
                                <input type="range" id="cloudVariants" min="1" max="5" value="3" step="1">
                            </div>
                            <div class="privacy-notice">
                                <small>‚ÑπÔ∏è Cloud analysis sends board positions to chess-api.com. No personal data is transmitted.</small>
                            </div>
                        </div>

                        <div id="engineStatus" class="engine-status">
                            <span class="status-indicator">‚ö´</span>
                            <span class="status-text">Engine: Not initialized</span>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4>Game Settings</h4>
                        <div class="control-group">
                            <label class="toggle-switch-label">
                                <span>‚è±Ô∏è Enable Clock</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="clockEnabled">
                                    <span class="toggle-slider"></span>
                                </label>
                            </label>
                            <select id="clockPreset" class="clock-preset-select">
                                <option value="bullet_1">1+0 Bullet</option>
                                <option value="blitz_3">3+0 Blitz</option>
                                <option value="blitz_5">5+0 Blitz</option>
                                <option value="rapid_10" selected>10+0 Rapid</option>
                                <option value="classical_30">30+0 Classical</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="showHints" checked>
                                Pause & Explain Mistakes
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="analysisMode">
                                Analysis Mode (No AI)
                            </label>
                            <label class="checkbox-label">
                                <input type="checkbox" id="noHintsMode">
                                Play Without Hints (Analyze Later)
                            </label>
                        </div>

                        <div class="control-group">
                            <label for="difficulty">Opponent Level:</label>
                            <select id="difficulty">
                                <option value="1">Beginner</option>
                                <option value="3">Easy</option>
                                <option value="5">Intermediate</option>
                                <option value="8" selected>Medium</option>
                                <option value="10">Challenging</option>
                                <option value="13">Hard</option>
                                <option value="16">Expert</option>
                                <option value="20">Master</option>
                                <option value="25">Grandmaster</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="analysisDepth">Analysis Depth:</label>
                            <select id="analysisDepth">
                                <option value="10">Fast</option>
                                <option value="15" selected>Balanced</option>
                                <option value="20">Deep</option>
                            </select>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4>Appearance</h4>
                        <div class="control-group">
                            <label class="toggle-switch-label">
                                <span>üåô Dark Mode</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="darkModeToggle" checked>
                                    <span class="toggle-slider"></span>
                                </label>
                            </label>
                        </div>

                        <div class="control-group">
                            <label for="boardTheme">Board:</label>
                            <select id="boardTheme">
                                <option value="brown">Brown</option>
                                <option value="blue">Blue</option>
                                <option value="green">Green</option>
                                <option value="marble">Marble</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="pieceSet">Pieces:</label>
                            <select id="pieceSet">
                                <option value="cburnett">Classic</option>
                                <option value="merida">Merida</option>
                                <option value="chess7">Chess7</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label for="boardSize">Board Size: <span id="boardSizeValue">600px</span></label>
                            <input type="range" id="boardSize" min="300" max="800" value="600" step="50">
                        </div>

                        <div class="control-group">
                            <label for="animationSpeed">Animation:</label>
                            <select id="animationSpeed">
                                <option value="instant">Instant</option>
                                <option value="fast">Fast</option>
                                <option value="normal" selected>Normal</option>
                                <option value="slow">Slow</option>
                            </select>
                        </div>

                        <div class="control-group">
                            <label class="checkbox-label">
                                <input type="checkbox" id="soundToggle" checked>
                                Sound Effects
                            </label>
                        </div>
                    </div>

                    <div class="settings-section">
                        <h4>Multiplayer & Community</h4>
                        <div class="control-group">
                            <label class="toggle-switch-label">
                                <span>üë• Pass & Play Mode</span>
                                <label class="toggle-switch">
                                    <input type="checkbox" id="localMultiplayer">
                                    <span class="toggle-slider"></span>
                                </label>
                            </label>
                            <p class="section-hint">Play against a friend on the same device</p>
                        </div>

                        <div class="multiplayer-quick-section">
                            <h5>Online Multiplayer</h5>
                            <div id="onlineStatus" class="online-status disconnected">Disconnected</div>
                            <div id="connectionPanel">
                                <p class="section-hint">Your Peer ID:</p>
                                <div class="id-container">
                                    <code id="myPeerId">---</code>
                                    <button id="copyIdBtn" class="icon-btn" title="Copy ID">üìã</button>
                                </div>
                                <div class="connect-input-group">
                                    <input type="text" id="remotePeerId" placeholder="Friend's Peer ID">
                                    <button id="connectBtn" class="primary-btn">Connect</button>
                                </div>
                            </div>
                            <div id="activeConnectionPanel" style="display: none;">
                                <div class="opponent-info">
                                    Connected to: <span id="connectedPeerId">---</span>
                                </div>
                                <button id="disconnectBtn" class="danger-btn">Disconnect</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Multiplayer features now integrated into Settings -->
                <!-- Community/Multiplayer features can be accessed from Settings context -->
            </div>
        </div>
        </aside>

        <!-- Right Panel Collapse Toggle (when collapsed) -->
        <button class="panel-expand-btn right-expand" id="rightPanelExpandBtn" style="display: none;" title="Expand panel">
            <span class="expand-icon">‚Äπ</span>
        </button>
    </div>

    <!-- Mobile Bottom Sheet -->
    <div class="bottom-sheet" id="bottomSheet">
        <div class="bottom-sheet-handle">
            <div class="handle-bar"></div>
        </div>
        <div class="bottom-sheet-content">
            <!-- Tab Navigation for Mobile -->
            <div class="bottom-sheet-tabs">
                <button class="bottom-tab active" data-tab="play">
                    <span class="tab-icon">üéÆ</span>
                    <span class="tab-label">Play</span>
                </button>
                <button class="bottom-tab" data-tab="analysis">
                    <span class="tab-icon">üß†</span>
                    <span class="tab-label">Analysis</span>
                </button>
                <button class="bottom-tab" data-tab="settings">
                    <span class="tab-icon">‚öôÔ∏è</span>
                    <span class="tab-label">Settings</span>
                </button>
                <button class="bottom-tab" data-tab="community">
                    <span class="tab-icon">üë•</span>
                    <span class="tab-label">Community</span>
                </button>
            </div>
            <!-- Content will be synced with sidebar tabs -->
        </div>
    </div>

    <!-- Floating Action Button (Mobile) -->
    <button class="fab" id="mobileFab" title="New Game">
        <span class="fab-icon">+</span>
    </button>

    <!-- FAB Menu (Mobile) -->
    <div class="fab-menu" id="fabMenu" style="display: none;">
        <button class="fab-menu-item" id="fabNewGame">
            <span class="fab-menu-icon">üéÆ</span>
            <span class="fab-menu-label">New Game</span>
        </button>
        <button class="fab-menu-item" id="fabUndo">
            <span class="fab-menu-icon">‚Ü∂</span>
            <span class="fab-menu-label">Undo</span>
        </button>
        <button class="fab-menu-item" id="fabAnalyze">
            <span class="fab-menu-icon">üîç</span>
            <span class="fab-menu-label">Analyze</span>
        </button>
        <button class="fab-menu-item" id="fabFlip">
            <span class="fab-menu-icon">üîÑ</span>
            <span class="fab-menu-label">Flip Board</span>
        </button>
    </div>
    </div>

    <!-- Hidden file input for PGN import -->
    <input type="file" id="pgnFileInput" accept=".pgn" style="display: none;">

    <!-- Load Game Modal -->
    <div id="loadGameModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Load Saved Game</h3>
                <button id="closeModalBtn" class="close-btn">&times;</button>
            </div>
            <div id="savedGamesList" class="saved-games-list">
                <div class="no-games">No saved games found</div>
            </div>
        </div>
    </div>

    <!-- Context-aware navigation system -->
    <script type="module" src="context-manager.js"></script>
    <script type="module" src="keyboard-shortcuts.js"></script>

    <!-- Enhanced features modules -->
    <script type="module" src="welcome-experience.js"></script>
    <script type="module" src="daily-goals.js"></script>
    <script type="module" src="progress-tracker.js"></script>
    <script type="module" src="visual-analysis.js"></script>
    <script type="module" src="achievement-visuals.js"></script>
    <script type="module" src="enhanced-features-init.js"></script>

    <!-- Existing modules -->
    <script type="module" src="layout-controller.js"></script>
    <script type="module" src="captured-pieces.js"></script>
    <script type="module" src="script.js"></script>

</body>

</html>